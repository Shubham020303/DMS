<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<!-- Add these meta tags in the head section -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<title>Dashboard | DMS</title>
	<script src="/static/js/tailwind.js"></script>
	<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
	<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
	<style>
		::-webkit-scrollbar {
			width: 8px;
		}

		::-webkit-scrollbar-track {
			background: #f1f1f1;
		}

		::-webkit-scrollbar-thumb {
			background: #888;
		}

		::-webkit-scrollbar-thumb:hover {
			background: #555;
		}

		input.gridjs-input {
			/* box-shadow: 0 0 0 1px #141414; */
		}

		input.gridjs-input:focus {
			border-color: #615FFF;
			box-shadow: 0 0 0 3px #615FFF80;
		}

		.gridjs-search-input {
			width: 100%;
		}

		.attendance-table {
			width: 100%;
			border-collapse: collapse;
		}
		.attendance-table th {
			background-color: #615FFF;
			color: white;
			padding: 10px;
			text-align: center;
			font-size: 16px;
		}
		.attendance-table td {
			padding: 8px 10px;
			border-bottom: 1px solid #ddd;
			font-size: 14px;
			text-align: center;
		}
		.attendance-table tr:nth-child(even) {
			background-color: #f9f9f9;
		}
		/* Responsive table for mobile */
		@media (max-width: 640px) {
			.attendance-table {
				font-size: 12px;
			}
			.attendance-table th,
			.attendance-table td {
				padding: 6px 4px;
				font-size: 12px;
			}
			.attendance-table th {
				font-size: 13px;
			}
		}
	</style>
</head>

<body>
	<section class="flex min-h-screen h-full bg-indigo-50">
		{% include 'student/studentnavbar.html' %}
		<div class="p-4 sm:p-6 lg:p-8 w-full lg:w-[calc(100vw-18rem)] lg:ml-[18rem] mt-16 lg:mt-0">
			<div class="flex items-center justify-between">
				<div class="w-full flex items-center justify-between">
					<h1 class="text-3xl font-bold">Attendance</h1>
				</div>
				<div>
					<button id="scanQrBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors whitespace-nowrap cursor-pointer">
						Scan QR Code
					</button>
				</div>
			</div>

			<div class="my-5 flex items-start justify-between gap-5 bg-white rounded-xl shadow-[3px_8px_20px_-10px_#00000015] overflow-hidden">
				<table class="attendance-table">
					<thead>
						<tr>
							
							<th>Date</th>
							<th>Time In</th>
							<th>Time Out</th>
							<th>Duration</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody>
						{% for attendance in attendance_data %}
						<tr>
							
							<td>{{ attendance.date|date:"d/m/Y" }}</td>
							<td>{{ attendance.timeIn|date:"h:i A" }}</td>
							<td>{{ attendance.timeOut|date:"h:i A" }}</td>
							<td>{{ attendance.totalTime }}m</td>
							<td>
								{% if attendance.status == 'Present' %}
								<span class="text-green-600">{{ attendance.status }}</span>
								{% else %}
								<span class="text-red-600">{{ attendance.status }}</span>
								{% endif %}
							</td>
						</tr>
						{% endfor %}
						{% if not attendance_data %}
						<tr>
							<td colspan="5" class="text-center text-gray-500">No attendance records found.</td>
						</tr>
						{% endif %}
					</tbody>
				</table>
			</div>
		</div>

		<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
			<div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
				<div class="flex items-center justify-between mb-4">
					<h3 class="text-xl font-semibold">Scan QR Code</h3>
					<button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
				</div>
				
				<div id="qrReader" class="w-full bg-gray-100 rounded-lg mb-4 flex flex-col items-center justify-center">
					<!-- <video id="qrVideo" class="w-full h-full object-cover rounded-lg" autoplay></video> -->
				</div>
				
				<div id="qrResult" class="hidden">
					<div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
						<p class="text-sm text-green-800">QR Code detected successfully!</p>
						<p class="text-xs text-gray-600 mt-1">Code: <span id="qrCodeValue"></span></p>
					</div>
					<button id="submitAttendance" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
						Submit Attendance
					</button>
				</div>
				
				<div id="qrError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
					<p class="text-sm text-red-800">Camera access denied or not available.</p>
				</div>
			</div>
		</div>
	</section>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
	<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const links = [...document.querySelectorAll('a')];

			links.forEach(link => {
				if (link.href === window.location.href) {
					link.querySelector('div').classList.add('bg-indigo-500', 'bg-opacity-80', 'text-white');
				}
			});
		});
	</script>
	<script>
		// QR Code scanning functionality - Cross-device compatible version
		let html5QrCodeScanner = null;
		let qrCodeData = null;

		document.getElementById('scanQrBtn').addEventListener('click', function() {
			document.getElementById('qrModal').classList.remove('hidden');
			document.getElementById('qrModal').classList.add('flex');
			
			// Add a small delay to ensure modal is visible before starting scanner
			setTimeout(() => {
				startQrScanner();
			}, 100);
		});

		document.getElementById('closeModal').addEventListener('click', function() {
			closeQrModal();
		});

		document.getElementById('qrModal').addEventListener('click', function(e) {
			if (e.target === this) {
				closeQrModal();
			}
		});

		document.getElementById('submitAttendance').addEventListener('click', function() {
			if (qrCodeData) {
				let formData = new FormData();
				formData.append('qr_code', qrCodeData);

				fetch("/student/scan-qr/", {
						method: "POST",
						body: formData
					})
					.then(response => response.json())
					.then(data => {
						console.log("Success:", data);
						alert(data.message);
					})
					.catch(error => {
						console.error("Error:", error);
						alert("An error occurred. Please try again.");
					})
					.finally(() => {
						closeQrModal();
						resetQrScanner();
					});
			}
		});

		async function startQrScanner() {
			// Check browser support first
			if (!checkBrowserSupport()) {
				return;
			}
			
			const qrResult = document.getElementById('qrResult');
			const qrError = document.getElementById('qrError');
			
			// Reset states
			qrResult.classList.add('hidden');
			qrError.classList.add('hidden');
			
			// Request camera permission first
			try {
				await requestCameraPermission();
			} catch (error) {
				handlePermissionError(error);
				return;
			}

			function onScanSuccess(decodedText, decodedResult) {
				qrCodeData = decodedText;
				document.getElementById('qrCodeValue').textContent = decodedText;
				document.getElementById('qrResult').classList.remove('hidden');
				
				// Stop scanning after successful detection
				if (html5QrCodeScanner) {
					html5QrCodeScanner.clear().catch(err => console.error('Clear error:', err));
				}
			}
			
			function onScanFailure(error) {
				// Only log errors, don't show them for scan failures (normal operation)
				// console.log('Scan failure:', error);
			}
			
			// Enhanced configuration for better cross-device compatibility
			const config = {
				fps: 10, // Lower FPS for better performance on mobile
				qrbox: function(viewfinderWidth, viewfinderHeight) {
					// Make QR box responsive
					let minEdgePercentage = 0.7;
					let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
					let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
					return {
						width: qrboxSize,
						height: qrboxSize
					};
				},
				aspectRatio: 1.0,
				supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
				formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
				rememberLastUsedCamera: true,
				showTorchButtonIfSupported: true,
				defaultZoomLevel: 1,
				useBarCodeDetectorIfSupported: true,
				// Additional mobile-friendly options
				videoConstraints: {
					facingMode: { ideal: "environment" }, // Prefer back camera
					width: { ideal: 1280 },
					height: { ideal: 720 }
				},
				// Disable verbose logging to reduce console noise
				verbose: false
			};
			
			try {
				// Ensure the QR reader element exists and is visible
				const qrReaderElement = document.getElementById("qrReader");
				if (!qrReaderElement) {
					throw new Error('QR reader element not found');
				}
				
				html5QrCodeScanner = new Html5QrcodeScanner("qrReader", config, false);
				html5QrCodeScanner.render(onScanSuccess, onScanFailure);
				
				// Hide the file input option if it exists (camera only)
				setTimeout(() => {
					const fileInputDiv = document.querySelector("#qrReader div:first-child");
					if (fileInputDiv) {
						fileInputDiv.style.display = "none";
					}
				}, 100);
				
			} catch (error) {
				console.error('QR Scanner initialization error:', error);
				handleScannerError(error);
			}
		}

		function closeQrModal() {
			document.getElementById('qrModal').classList.add('hidden');
			document.getElementById('qrModal').classList.remove('flex');
			
			// Stop scanner with better error handling
			if (html5QrCodeScanner) {
				html5QrCodeScanner.clear().then(() => {
					html5QrCodeScanner = null;
				}).catch(error => {
					console.error('Error clearing scanner:', error);
					html5QrCodeScanner = null;
				});
			}
		}

		function resetQrScanner() {
			qrCodeData = null;
			document.getElementById('qrResult').classList.add('hidden');
			document.getElementById('qrError').classList.add('hidden');
		}

		// Enhanced camera permission request with HTTP fallback
		async function requestCameraPermission() {
			// For HTTP, try legacy getUserMedia first
			if (location.protocol === 'http:') {
				try {
					// Try legacy methods for HTTP
					const getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
					if (getUserMedia) {
						return new Promise((resolve, reject) => {
							getUserMedia.call(navigator, { video: true }, 
							(stream) => {
								stream.getTracks().forEach(track => track.stop());
								resolve(true);
							},
							(error) => reject(error)
							);
						});
					}
				} catch (error) {
					console.log('Legacy getUserMedia failed:', error);
				}
			}
			
			// Try modern API (works on HTTPS and some HTTP localhost)
			if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
				throw new Error('Camera API not available on HTTP. Use HTTPS or localhost.');
			}
			
			try {
				const stream = await navigator.mediaDevices.getUserMedia({ 
					video: { 
						facingMode: { ideal: "environment" },
						width: { ideal: 1280 },
						height: { ideal: 720 }
					} 
				});
				
				stream.getTracks().forEach(track => track.stop());
				return true;
				
			} catch (error) {
				// If environment camera fails, try any camera
				try {
					const stream = await navigator.mediaDevices.getUserMedia({ video: true });
					stream.getTracks().forEach(track => track.stop());
					return true;
				} catch (fallbackError) {
					throw fallbackError;
				}
			}
		}

		// Enhanced browser support check with mobile debugging
		function checkBrowserSupport() {
			let debugInfo = [];
			
			// Collect debug info for mobile
			debugInfo.push('Protocol: ' + location.protocol);
			debugInfo.push('Host: ' + location.hostname);
			debugInfo.push('Port: ' + location.port);
			debugInfo.push('Full URL: ' + location.href);
			debugInfo.push('UserAgent: ' + navigator.userAgent.substring(0, 80));
			debugInfo.push('MediaDevices: ' + (!!navigator.mediaDevices));
			debugInfo.push('GetUserMedia: ' + (!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)));
			debugInfo.push('Legacy getUserMedia: ' + (!!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia)));
			debugInfo.push('Html5QrcodeScanner: ' + (typeof Html5QrcodeScanner !== 'undefined'));
			
			// Show debug info on mobile - split into chunks for readability
			const chunks = [];
			for(let i = 0; i < debugInfo.length; i += 3) {
				chunks.push(debugInfo.slice(i, i + 3).join(' | '));
			}
			
			showError('Debug Info:<br>' + chunks.join('<br>'));
			
			// Always return true to test what the real error is
			return true;
		}

		// Handle permission-specific errors
		function handlePermissionError(error) {
			let errorMessage = '';
			
			switch(error.name) {
				case 'NotAllowedError':
					errorMessage = 'Camera access denied. Please allow camera permission and try again.';
					// iOS Safari specific guidance
					if (isIOSSafari()) {
						errorMessage += ' On iOS Safari, you may need to check Settings > Safari > Camera.';
					}
					break;
				case 'NotReadableError':
					errorMessage = 'Camera is currently in use by another application. Please close other camera apps and try again.';
					break;
				case 'NotFoundError':
					errorMessage = 'No camera found on your device. Please ensure your device has a working camera.';
					break;
				case 'SecurityError':
					errorMessage = 'Camera access blocked. ';
					if (location.protocol !== 'https:' && location.hostname !== 'localhost' && 
						!location.hostname.startsWith('192.168.') && !location.hostname.startsWith('10.')) {
						errorMessage += 'Try using localhost or a local IP address for HTTP development.';
					} else {
						errorMessage += 'Please check your browser security settings.';
					}
					break;
				case 'MediaDevices API not supported':
					errorMessage = 'Your browser doesn\'t support camera access. Please update to a newer version or use Chrome/Firefox/Safari.';
					break;
				default:
					errorMessage = `Camera access error: ${error.message || error}`;
			}
			
			showError(errorMessage);
		}

		// Handle scanner initialization errors
		function handleScannerError(error) {
			let errorMessage = 'Failed to initialize QR scanner. ';
			
			if (error.message && error.message.includes('QR reader element not found')) {
				errorMessage += 'Please refresh the page and try again.';
			} else {
				errorMessage += 'Please check your camera permissions and try again.';
			}
			
			showError(errorMessage);
		}

		// Utility function to show errors
		function showError(message) {
			const qrError = document.getElementById('qrError');
			if (qrError) {
				qrError.innerHTML = `<p class="text-sm text-red-800">${message}</p>`;
				qrError.classList.remove('hidden');
			} else {
				console.error('Error element not found:', message);
				alert(message); // Fallback
			}
		}

		// Detect iOS Safari
		function isIOSSafari() {
			const ua = navigator.userAgent;
			const iOS = /iPad|iPhone|iPod/.test(ua);
			const webkit = /WebKit/.test(ua);
			const chrome = /CriOS|Chrome/.test(ua);
			return iOS && webkit && !chrome;
		}

		// Additional mobile optimization: Handle orientation changes
		window.addEventListener('orientationchange', function() {
			if (html5QrCodeScanner) {
				// Restart scanner after orientation change
				setTimeout(() => {
					closeQrModal();
					setTimeout(() => {
						document.getElementById('scanQrBtn').click();
					}, 500);
				}, 500);
			}
		});

		// Handle page visibility changes (important for mobile)
		document.addEventListener('visibilitychange', function() {
			if (document.hidden && html5QrCodeScanner) {
				// Pause scanner when page is hidden
				closeQrModal();
			}
		});
	</script>
</body>

</html>