<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dashboard | DMS</title>
	<script src="https://unpkg.com/@tailwindcss/browser@4"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
	<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
	<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
	<style>
		::-webkit-scrollbar {
			width: 8px;
		}
		::-webkit-scrollbar-track {
			background: #f1f1f1;
		}
		::-webkit-scrollbar-thumb {
			background: #888;
		}
		::-webkit-scrollbar-thumb:hover {
			background: #555;
		}
		input.gridjs-input{
			/* box-shadow: 0 0 0 1px #141414; */
		}
		input.gridjs-input:focus {
			border-color: #615FFF;
			box-shadow: 0 0 0 3px #615FFF80;
		}
		.gridjs-search-input{
			width: 100%;
		}
		.gridjs-th-content{
			white-space: normal;
		}
		#notification-list::-webkit-scrollbar {
			width: 4px;
		}

		#notification-list::-webkit-scrollbar-track {
			background: #f1f1f1;
		}

		#notification-list::-webkit-scrollbar-thumb {
			background: #c7c7c7;
			border-radius: 4px;
		}

		#notification-list::-webkit-scrollbar-thumb:hover {
			background: #a0a0a0;
		}

		.notification-item {
			position: relative;
			transition: all 0.2s ease-in-out;
			transform: translateX(0);
			opacity: 1;
		}

		.notification-item:hover {
			transform: translateX(2px);
		}

		.notification-item.sliding-out {
			transform: translateX(100%);
			opacity: 0;
		}
	</style>
</head>

<body>
	<section class="flex min-h-screen bg-indigo-50">
		{% include 'navbar.html' %}
		<div class="p-8 w-[calc(100vw-18rem)] ml-[18rem]">
			<div class="w-full flex items-center justify-between">
				<h1 class="text-3xl font-bold">Dashboard</h1>
				<div class="relative" id="notification-container" style="display: none;">
					<div id="notificationBtn"
						class="bg-white p-3 rounded-full shadow cursor-pointer flex items-center justify-center relative">
						<div class="">
							<svg viewBox="0 0 24 24" fill="none" class="w-6 h-6 text-indigo-400">
								<path d="M6.502 6.975a5.525 5.525 0 0 1 10.995 0l.287 2.866c.018.175.026.262.037.348a8 8 0 0 0 1.19 3.325l.192.291.861 1.292c.787 1.18 1.18 1.769 1.008 2.244-.033.09-.078.175-.135.252-.3.407-1.009.407-2.426.407H5.489c-1.417 0-2.126 0-2.426-.407a1 1 0 0 1-.134-.252c-.173-.475.22-1.065 1.006-2.244l.862-1.292.192-.291a8 8 0 0 0 1.19-3.325c.01-.086.02-.173.037-.348l.286-2.866Z"
									fill="currentColor"></path>
								<path d="M10.068 20.63c.114.106.365.2.715.267.349.067.777.103 1.217.103.44 0 .868-.036 1.217-.103.35-.067.6-.161.715-.268"
									stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
							</svg>
							<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full" id="notification-count">0</span>
						</div>
					</div>

					<div id="notificationModal" class="w-full min-w-[450px] max-w-[450px] absolute top-14 right-0 scale-y-0 opacity-0 origin-top bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300 z-50">
						<div class="px-4 py-3 bg-indigo-50 border-b border-indigo-100">
							<h3 class="text-lg font-semibold text-indigo-900">Notifications</h3>
						</div>
						
						<div class="max-h-[400px] overflow-y-auto overflow-x-hidden" id="notification-list">
							<!-- Notifications will be dynamically inserted here -->
						</div>
					</div>
				</div>
			</div>
			<div class="my-5 flex flex-col gap-5 bg-white p-5 rounded-xl shadow-[3px_8px_20px_-10px_#00000015]">
				<div>
					<p class="text-3xl font-semibold">Daily Schedule</p>
				</div>
				<div class="w-full">
					<div id="daily-time-slots" class="w-full"></div>
				</div>
				<!-- <div class="flex items-center justify-between gap-5">
					<div class="flex items-center gap-5">
						<div class="flex flex-col gap-2 w-[200px]">
							<label for="vehicle" class="block font-semibold">Select Vehicle</label>
							<select name="vehicle" id="vehicle" class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" required>
								<option disabled selected>Select Vehicle</option>
							</select>
						</div>
						<div class="flex flex-col gap-2 w-[200px]">
							<label for="branch" class="block font-semibold">Select Branch</label>
							<select name="branch" id="branch" class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" required>
								<option disabled selected>Select Branch</option>
							</select>
						</div>
					</div>
					<div id="clear-filters" class="bg-indigo-500 text-white px-4 py-2 rounded cursor-pointer flex items-center gap-2">
						<p>Clear Filter</p>
					</div>
				</div>
				<div class="flex items-start justify-between gap-5">
					<div id="appointment-table-before-lunch" class="w-1/2"></div>
					<div id="appointment-table-after-lunch" class="w-1/2"></div>
				</div> -->
			</div>
			<div class="my-5 flex flex-col gap-5 bg-white p-5 rounded-xl shadow-[3px_8px_20px_-10px_#00000015]">
				<div>
					<p class="text-3xl font-semibold">On Leave Students</p>
				</div>
				<div id="on-leave-table" class="w-full"></div>
			</div>
			<div class="my-5 flex flex-col gap-5 bg-white p-5 rounded-xl shadow-[3px_8px_20px_-10px_#00000015]">
				<div>
					<p class="text-3xl font-semibold">Payment Remaining</p>
				</div>
				<div id="payment-status-table" class="w-full"></div>
			</div>
			<div class="my-5 flex flex-col gap-5 bg-white p-5 rounded-xl shadow-[3px_8px_20px_-10px_#00000015]">
				<div>
					<p class="text-3xl font-semibold">Payment Received</p>
				</div>
				<div id="received-payment-table" class="w-full"></div>
			</div>
			<div class="my-5 flex flex-col gap-5 bg-white p-5 rounded-xl shadow-[3px_8px_20px_-10px_#00000015]">
				<div class="flex items-center justify-between">
					<p class="text-3xl font-semibold">Earnings</p>
					<!-- <div class="flex items-center gap-5">
						<div class="flex flex-col gap-2 w-full">
							<label for="dlIssueDate" class="block font-semibold">From Date</label>
							<input type="date" name="dlIssueDate" id="dlIssueDate" autocomplete="off" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
						</div>
						<div class="flex flex-col gap-2 w-full">
							<label for="dlIssueDate" class="block font-semibold">End Date</label>
							<input type="date" name="dlIssueDate" id="dlIssueDate" autocomplete="off" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
						</div>
					</div> -->
				</div>
				<div id="earnings-table" class="w-full"></div>
			</div>
			<!-- <div class="w-full grid grid-cols-1 lg:grid-cols-4 lg:grid-rows-3 gap-3 mt-10">
				<div
					class="bg-indigo-500 h-40 rounded-xl col-span-2 lg:col-span-1 flex flex-col items-center justify-center gap-3 shadow-[3px_8px_20px_-10px_#00000015]">
					<p class="text-white text-sm font-semibold">Sales: Aug 2027</p>
					<p class="text-white font-bold text-2xl">$5.73K</p>
					<p class="text-white text-xs ">Jul 2027: $10.35K</p>
				</div>
				<div
					class="bg-indigo-500 h-40 rounded-xl col-span-2 lg:col-span-1 flex flex-col items-center justify-center gap-3 shadow-[3px_8px_20px_-10px_#00000015]">
					<p class="text-white text-sm font-semibold">Average Order Value : Aug 2027</p>
					<p class="text-white font-bold text-2xl">$34</p>
					<p class="text-white text-xs ">Jul 2027: $0.23K</p>
				</div>
				<div
					class="bg-white h-full rounded-xl col-span-2 row-span-2 flex flex-col items-center justify-center gap-3 shadow-[3px_8px_20px_-10px_#00000015] p-3">
					<p class="text-indigo-500 text-sm font-semibold">Attendance</p>
					<canvas id="myChart"></canvas>
				</div>
				<div
					class="bg-white h-full rounded-xl col-span-2 row-span-2 shadow-[3px_8px_20px_-10px_#00000015] p-6">
					<div class="flex items-center justify-between">
						<p class="text-sm text-indigo-800 font-bold">Staging Orders</p>
					</div>
					<div class="grid grid-cols-3 gap-4 mt-8">
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">18</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">Payment</p>
						</div>
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">12</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">In work</p>
						</div>
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">32</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">Delivery</p>
						</div>
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">32</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">Delivered</p>
						</div>
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">4</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">Failed</p>
						</div>
						<div
							class="w-full h-28 bg-indigo-50 rounded-lg shadow-inner flex flex-col items-center justify-center">
							<p class="text-2xl text-indigo-900 font-bold">11</p>
							<p class="text-xs text-indigo-900 font-bold mt-3">Return</p>
						</div>
					</div>
				</div>
				<div
					class="bg-indigo-500 h-40 rounded-xl col-span-2 lg:col-span-1 flex flex-col items-center justify-center gap-3 shadow-[3px_8px_20px_-10px_#00000015]">
					<p class="text-white text-sm font-semibold">Total Profit: Aug 2027</p>
					<p class="text-white font-bold text-2xl">$1.2K</p>
					<p class="text-white text-xs ">Jul 2027: $0.8K</p>
				</div>
				<div
					class="bg-indigo-500 h-40 rounded-xl col-span-2 lg:col-span-1 flex flex-col items-center justify-center gap-3 shadow-[3px_8px_20px_-10px_#00000015]">
					<p class="text-white text-sm font-semibold">Cutomers: Aug 2027</p>
					<p class="text-white font-bold text-2xl">144</p>
					<p class="text-white text-xs ">Jul 2027: 121</p>
				</div>
			</div> -->
		</div>
	</section>
	<section class="fixed top-0 left-0 w-full h-full bg-black/80 flex justify-center items-center scale-0 opacity-0 z-50 transition-all duration-300" id="add-payment-modal">
		<div class="bg-white p-8 rounded-lg w-1/2 flex flex-col gap-6">
			<div class="flex justify-between items-center">
				<h1 id="payment-model-heading" class="text-3xl font-bold">Receive Payment</h1>
				<div class="bg-[#141414] flex items-center justify-center p-2 text-white rounded-full cursor-pointer" id="close-payment-modal">
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
						<path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
					</svg>
				</div>
			</div>
			<form action="" method="POST" class="w-full flex flex-col gap-6 max-h-[500px] overflow-y-auto pr-2" enctype="multipart/form-data" id="add-payment-form">
				{%csrf_token%}
				<div class="w-full">
					<div class="mb-4 flex items-start gap-4 w-full">
						<div class="flex items-center gap-4 w-full">
							<div class="flex flex-col gap-2 w-1/2">
								<label for="studentName" class="block font-semibold">Student</label>
								<input type="text" name="studentName" id="studentName" autocomplete="off" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
							</div>
							<div class="flex flex-col gap-2 w-1/2">
								<label for="paymentDate" class="block font-semibold">Date</label>
								<input type="date" name="paymentDate" id="paymentDate" autocomplete="off" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
							</div>
						</div>
					</div>
					<div class="mb-4 flex items-center gap-4 w-full">
						<div class="flex flex-col gap-2 w-1/2">
							<label for="paymentDue" class="block font-semibold">Payment Due</label>
							<input type="text" name="paymentDue" id="paymentDue" autocomplete="off" pattern="[0-9]{10}" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
						</div>
						<div class="flex flex-col gap-2 w-1/2">
							<label for="paymentReceived" class="block font-semibold">Payment Received</label>
							<input type="text" name="paymentReceived" id="paymentReceived" autocomplete="off" required class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
						</div>
					</div>
					<div class="mb-4 flex items-center gap-4 w-full">
						<div class="flex flex-col gap-2 w-1/2">
							<label for="paymentReceivedBy" class="block font-semibold">Payment Receiver</label>
							<select name="paymentReceivedBy" id="paymentReceivedBy" class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" required>
								<option disabled selected>Select Person</option>
							</select>
						</div>
						<div class="flex flex-col gap-2 w-1/2">
							<label for="paymentMethod" class="block font-semibold">Payment Method</label>
							<select name="paymentMethod" id="paymentMethod" class="block w-full rounded-lg bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" required>
								<option disabled selected>Select Method</option>
								<option value="Cash">Cash</option>
								<option value="Online">Online</option>
							</select>
						</div>
					</div>
				</div>
				<div id="btns-container" class="flex justify-end">
					<button id="add-payment-btn" class="bg-indigo-600 text-white px-6 py-2 rounded cursor-pointer mr-2">
						<p>Add</p>
					</button>
					<botton id="close-add-payment-modal" class="bg-red-700 text-white px-4 py-2 rounded cursor-pointer">
						<p>Cancel</p>
					</botton>
				</div>
			</form>
		</div>
	</section>
	<section class="fixed top-0 left-0 w-full h-full bg-black/80 flex justify-center items-center scale-0 opacity-0 z-50 transition-all duration-300" id="updated-payment-modal">
		<div class="bg-white p-8 rounded-lg w-1/2 flex flex-col gap-6">
			<div class="flex justify-between items-center">
				<h1 id="update-payment-heading" class="text-2xl font-bold">Update Payment</h1>
				<div class="bg-[#141414] flex items-center justify-center p-2 text-white rounded-full cursor-pointer" id="close-update-payment-btn">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
						<path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
					</svg>
				</div>
			</div>
			<div class="flex flex-col gap-2">
				<p id="update-payment-message">Payment details updated successfully.</p>
			</div>
			<div class="flex justify-end">
				<botton id="close-update-payment-modal" class="bg-indigo-600 text-white px-4 py-2 rounded cursor-pointer">
					<p>Close</p>
				</botton>
			</div>
		</div>
	</section>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
	<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
	<script>
		// const ctx = document.getElementById('myChart');

		// new Chart(ctx, {
		// 	type: 'bar',
		// 	data: {
		// 		labels: ["January", "February", "March", "April", "March", "May", "June"],
		// 		datasets: [
		// 			{
		// 				label: "Attandance",
		// 				data: [10, 20, 50, 30, 32, 20, 25],
		// 				backgroundColor: "#E0E7FF",
		// 				borderColor: "#615FFF",
		// 				borderWidth: 1,
		// 			},
		// 		],
		// 	},
		// 	options: {
		// 		scales: {
		// 			y: {
		// 				beginAtZero: true
		// 			}
		// 		}
		// 	}
		// });

		document.addEventListener('DOMContentLoaded', () => {
			// fetch("http://127.0.0.1:8000/getVehicleData/")
			// 	.then(response => response.json())
			// 	.then(data => {
			// 		document.getElementById("vehicle").innerHTML += data.map(vehicle => `<option value="${vehicle.vehicalName}">${vehicle.vehicalName}</option>`).join('');
			// 	})

			// fetch("http://127.0.0.1:8000/getBranchData/")
			// 	.then(response => response.json())
			// 	.then(data => {
			// 		document.getElementById("branch").innerHTML += data.map(branch => `<option value="${branch.branchName}">${branch.branchName}</option>`).join('');
			// 	})

			fetch("http://127.0.0.1:8000/getInstructorData/")
				.then(response => response.json())
				.then(data => {
					document.getElementById("paymentReceivedBy").innerHTML += data.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
				})

			const notificationList = document.getElementById('notification-list');
			const notificationCount = document.getElementById('notification-count');
			let unreadCount = 0;

			function fetchNotifications() {
				fetch('http://127.0.0.1:8000/getNotificationData/')
					.then(response => response.json())
					.then(data => {
						const notificationContainer = document.getElementById('notification-container');
						
						// Show/hide notification bell based on notifications
						if (data.length === 0) {
							notificationContainer.style.display = 'none';
							return;
						} else {
							notificationContainer.style.display = 'block';
						}

						// Update notification count
						document.getElementById('notification-count').textContent = data.length;
						
						// Update notification list
						const notificationList = document.getElementById('notification-list');
						notificationList.innerHTML = data.map(notification => `
							<div class="notification-item group bg-white hover:bg-gray-50 transition-all duration-200" data-id="${notification.id}">
								<div class="p-4 flex items-start gap-3 border-b border-gray-100">
									<div class="flex-1">
										<p class="text-sm font-medium text-gray-900">
											${notification.notificationTitle}
										</p>
										<div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
											<span>${notification.notificationTime}</span>
											<span>•</span>
											<span>${formatDateToLongDate(notification.notificationDate)}</span>
										</div>
									</div>
									<button class="mark-read-btn flex items-center gap-2 bg-indigo-100 text-indigo-600 text-xs px-2 py-1 rounded-full cursor-pointer opacity-0 group-hover:opacity-100 transition-all duration-200" data-id="${notification.id}">
										Mark as read
									</button>
								</div>
							</div>
						`).join('');

						// Add click event to mark as read button

						const markAsReadButtons = notificationList.querySelectorAll('.mark-read-btn');
						markAsReadButtons.forEach(button => {
							button.addEventListener('click', () => {
								const notificationId = button.getAttribute('data-id');
								markNotificationAsRead(notificationId);
							});
						});
					})
					.catch(error => {
						console.error('Error fetching notifications:', error);
						document.getElementById('notification-container').style.display = 'none';
					});
			}

			function markNotificationAsRead(notificationId) {
				let formData = new FormData();
				formData.append('notificationId', notificationId);
				fetch('http://127.0.0.1:8000/manage-Notification/', {
					method: 'POST',
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
						if (notificationItem) {
							notificationItem.classList.add('sliding-out');
							
							setTimeout(() => {
								notificationItem.remove();
								
								const remainingNotifications = document.querySelectorAll('.notification-item');
								if (remainingNotifications.length === 0) {
									document.getElementById('notification-container').style.display = 'none';
								}
								
								const count = document.getElementById('notification-count');
								count.textContent = remainingNotifications.length;
							}, 200);
						}
					}
				});
			}

			// Initial fetch
			fetchNotifications();

			// Fetch notifications every 30 seconds
			setInterval(fetchNotifications, 30000);
		})

		function formatDateToLongDate(dateString) {
			if (!dateString) return "No Data Found";
			
			const date = new Date(dateString);
			const day = date.getDate();
			const month = date.toLocaleString('en-US', { month: 'long' });
			const year = date.getFullYear();

			// Add ordinal suffix to day
			const ordinal = (day) => {
				if (day > 3 && day < 21) return 'th';
				switch (day % 10) {
					case 1: return "st";
					case 2: return "nd";
					case 3: return "rd";
					default: return "th";
				}
			};

			return `${day}${ordinal(day)} ${month}, ${year}`;
		}

		document.getElementById("notificationBtn").addEventListener("click", function () {
			console.log("clicked");
			document.getElementById("notificationModal").classList.toggle("scale-y-0")
			document.getElementById("notificationModal").classList.toggle("opacity-0")
			document.getElementById("notificationModal").classList.toggle("scale-y-100")
			document.getElementById("notificationModal").classList.toggle("opacity-100")
		})
		
		document.getElementById("notificationModal").addEventListener("mouseleave", function () {
			setTimeout(() => {
				document.getElementById("notificationModal").classList.toggle("scale-y-0")
				document.getElementById("notificationModal").classList.toggle("opacity-0")
				document.getElementById("notificationModal").classList.toggle("scale-y-100")
				document.getElementById("notificationModal").classList.toggle("opacity-100")
			}, 1000);
		})

		document.getElementById('close-add-payment-modal').addEventListener('click', () => {
			document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
			document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
		});

		document.getElementById('close-payment-modal').addEventListener('click', () => {
			document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
			document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
		});

		// const vehicleSelect = document.getElementById("vehicle");
		// const branchSelect = document.getElementById("branch");

		// let slotData = { morning: [], evening: [] }; // Store API data globally

		// // Fetch data once and store it
		// function fetchSlotsDataOnce() {
		// 	fetch(`http://127.0.0.1:8000/getSlotWiseData/`)
		// 		.then(response => response.json())
		// 		.then(data => {
		// 			slotData = data; // Store fetched data
		// 			applyFilters(); // Apply filters after fetching data
		// 		})
		// 		.catch(error => console.error('Error fetching data:', error));
		// }

		// // Apply filters to stored data
		// function applyFilters() {
		// 	const vehicle = vehicleSelect.value;
		// 	const branch = branchSelect.value;

		// 	let morningData = [...slotData.morning]; // Copy stored data
		// 	let eveningData = [...slotData.evening];

		// 	console.log("vehicle", vehicle);
		// 	console.log("branch", branch);

		// 	// Apply filters only if values are selected
		// 	if (vehicle && vehicle !== "Select Vehicle") {
		// 		morningData = morningData.filter(slot => slot.vehicle === vehicle);
		// 		eveningData = eveningData.filter(slot => slot.vehicle === vehicle);
		// 	}

		// 	if (branch && branch !== "Select Branch") {
		// 		morningData = morningData.filter(slot => slot.branch === branch);
		// 		eveningData = eveningData.filter(slot => slot.branch === branch);
		// 	}

		// 	console.log("morningData", morningData);
		// 	console.log("eveningData", eveningData);

		// 	// ⚡ Destroy old tables by resetting their container
		// 	document.getElementById("appointment-table-before-lunch").innerHTML = '<div id="grid-morning"></div>';
		// 	document.getElementById("appointment-table-after-lunch").innerHTML = '<div id="grid-evening"></div>';

		// 	// Create and render morning table
		// 	new gridjs.Grid({
		// 		search: false,
		// 		sort: true,
		// 		fixedHeader: true,
		// 		columns: ["Slot", "Name"],
		// 		data: morningData.map(slot => [slot.slotTime, slot.studentName != null ? slot.studentName : "-"]),
		// 		className: {
		// 			th: '!bg-black !text-white',
		// 			sort: '!bg-black !text-white',
		// 			search: '!float-right !w-[25%]',
		// 		}
		// 	}).render(document.getElementById("grid-morning"));

		// 	// Create and render evening table
		// 	new gridjs.Grid({
		// 		search: false,
		// 		sort: true,
		// 		fixedHeader: true,
		// 		columns: ["Slot", "Name"],
		// 		data: eveningData.map(slot => [slot.slotTime, slot.studentName != null ? slot.studentName : "-"]),
		// 		className: {
		// 			th: '!bg-black !text-white',
		// 			sort: '!bg-black !text-white',
		// 			search: '!float-right !w-[25%]',
		// 		}
		// 	}).render(document.getElementById("grid-evening"));
		// }

		// // Event listeners for dropdown changes
		// vehicleSelect.addEventListener("change", applyFilters);
		// branchSelect.addEventListener("change", applyFilters);

		// // Initial API fetch
		// fetchSlotsDataOnce();

		// document.getElementById("clear-filters").addEventListener("click", function () {
		// 	vehicleSelect.value = "Select Vehicle";
		// 	branchSelect.value = "Select Branch";
		// 	applyFilters();
		// })

		document.getElementById("add-payment-form").addEventListener("submit", (e) => {
			if (document.getElementById('add-payment-btn').innerText === "Update") {
				e.preventDefault();
				const form = e.target; // Get the form element
				const formData = new FormData(form); // Correctly create FormData

				fetch("/manage-payment/", {
					method: "POST", // Change to PUT if updating
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					console.log("Success:", data);
					if (data.success) {
						document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
						document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
						document.getElementById("update-payment-message").innerText = "Payment details updated successfully."
						document.getElementById("update-payment-heading").innerText = "Update Payment"
					} else if (data.error) {
						console.error("Error:", data.error);
						document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
						document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
						document.getElementById("update-payment-message").innerText = data.error;
						document.getElementById("update-payment-heading").innerText = "Error"
					}
				})
				.catch(error => {
					console.error("Error:", error);
					document.getElementById('add-paymnet-modal').classList.remove('scale-100', 'opacity-100');
					document.getElementById('add-paymnet-modal').classList.add('scale-0', 'opacity-0');
					document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
					document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
					document.getElementById("update-payment-message").innerText = "Error updating payment information."
				});
			} else {
				e.preventDefault();
				const form = e.target; // Get the form element
				const formData = new FormData(form); // Correctly create FormData

				fetch("/manage-payment/", {
					method: "POST", // Change to PUT if updating
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					console.log("Success:", data);
					if (data.success) {
						document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
						document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
						document.getElementById("update-payment-message").innerText = "Payment details added successfully."
						document.getElementById("update-payment-heading").innerText = "Add Payment"
					} else if (data.error) {
						console.error("Error:", data.error);
						document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
						document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
						document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
						document.getElementById("update-payment-message").innerText = data.error;
						document.getElementById("update-payment-heading").innerText = "Error"
					}
				})
				.catch(error => {
					console.error("Error:", error);
					document.getElementById('add-payment-modal').classList.remove('scale-100', 'opacity-100');
					document.getElementById('add-payment-modal').classList.add('scale-0', 'opacity-0');
					document.getElementById("updated-payment-modal").classList.remove('scale-0', 'opacity-0');
					document.getElementById("updated-payment-modal").classList.add('scale-100', 'opacity-100');
					document.getElementById("update-payment-message").innerText = "Error adding payment information."
				});
			}
		})

		document.getElementById("paymentReceived").addEventListener("input", () => {
			const paymentReceivedInput = document.getElementById("paymentReceived");
			const paymentDueInput = document.getElementById("paymentDue");

			const originalPaymentDue = parseFloat(paymentDueInput.getAttribute("data-original")) || 0;
			let paymentReceived = parseFloat(paymentReceivedInput.value) || 0;

			// Ensure payment received does not exceed the original due
			if (paymentReceived > originalPaymentDue) {
				paymentReceived = originalPaymentDue;
				paymentReceivedInput.value = originalPaymentDue; // Reset input value
			}

			// Update payment due dynamically
			paymentDueInput.value = originalPaymentDue - paymentReceived;
		});

		const paymentGrid = new gridjs.Grid({
			search: true,
			// pagination: {
			// 	limit: 5,
			// 	summary: false
			// },
			sort: true,
			fixedHeader: true,
			columns: [
				{
					id: "id",
					name: "ID",
					width: '5%',
					formatter: (cell, row) => {
						cell = `<span class="text-indigo-600 font-semibold">${cell}</span>`;
						return gridjs.html(cell);
					},
					hidden: true
				},
				"Name",
				"Course",
				{
					name:"Amount Paid",
					width: "13%"
				},
				{ 
					name: "Amount Remaining",
					width: "13%"
				},
				{
					name:"Total Amount",
					width: "13%"
				},
				"Due Date",
				{
					name: "Action",
					formatter: (cell, row) => {
						let editBtn = gridjs.h('button', {
							className: 'p-3 bg-indigo-600 text-white rounded-lg cursor-pointer',
							innerHTML: `
								Receive Payment
							`,
							onClick: () => {
								const studentNameInput = document.getElementById("studentName");
								const paymentDateInput = document.getElementById("paymentDate");
								const paymentDueInput = document.getElementById("paymentDue");

								// Set today's date before making it readonly
								const todayDate = new Date().toISOString().split('T')[0];

								setTimeout(() => {
									document.getElementById("paymentDate").value = todayDate;
								}, 100); // Delay ensures it persists after potential resets

								// Remove required attributes and set readonly
								studentNameInput.removeAttribute("required");
								paymentDateInput.removeAttribute("required");
								paymentDueInput.removeAttribute("required");

								studentNameInput.setAttribute("readonly", true);
								paymentDateInput.setAttribute("readonly", true);
								paymentDueInput.setAttribute("readonly", true);

								// Remove focus styles
								studentNameInput.classList.remove('focus:outline-2', 'focus:-outline-offset-2', 'focus:outline-indigo-600');
								paymentDateInput.classList.remove('focus:outline-2', 'focus:-outline-offset-2', 'focus:outline-indigo-600');
								paymentDueInput.classList.remove('focus:outline-2', 'focus:-outline-offset-2', 'focus:outline-indigo-600');

								// Ensure row.cells[0].data is valid
								const studentId = row.cells[0].data

								// Fetch payment data
								fetch(`http://127.0.0.1:8000/getReamainingPaymentData/?studentId=${studentId}`)
									.then(response => response.json())
									.then(data => {
										console.log("API Response:", data);

										document.getElementById("studentName").value = data.name;
										document.getElementById("paymentDue").value = data.paymentDue;
										document.getElementById("paymentDue").setAttribute("data-original", data.paymentDue);
									})
									.catch(error => console.error("Fetch error:", error));

								// Add hidden input for student ID
								document.getElementById("add-payment-form").innerHTML += 
									`<input type="hidden" name="studentId" id="studentId" value="${studentId}">`;

								// Show modal
								document.getElementById('add-payment-modal').classList.remove('scale-0', 'opacity-0');
								document.getElementById('add-payment-modal').classList.add('scale-100', 'opacity-100');
							}
						}, '');
						return gridjs.h('div', {
							className: 'flex gap-4'
						}, editBtn);
					},
					width: '17%'
				}
			],
			server: {
				url: 'http://127.0.0.1:8000/getReamainingPaymentData/',
				then: data => data.map(payment => [payment.studentId, payment.name, payment.courseName, payment.amountPaid, payment.amountPending, payment.TotalAmount, payment.paymentDueDate])
			},
			className: {
				th: '!bg-black !text-white',
				sort: '!bg-black !text-white',
				search: '!float-right !w-[25%]',
			}
		})

		const receivedPaymentGrid = new gridjs.Grid({
			search: true,
			// pagination: {
			// 	limit: 5,
			// 	summary: false
			// },
			sort: true,
			fixedHeader: true,
			columns: [
				{
					id: "id",
					name: "ID",
					width: '5%',
					formatter: (cell, row) => {
						cell = `<span class="text-indigo-600 font-semibold">${cell}</span>`;
						return gridjs.html(cell);
					},
					hidden: true
				},
				"Name",
				{
					name:"Total Amount",
				},
				{ 
					name: "Payment Date",
				},
				{
					name:"Payment Receiver",
				},
				{
					name:"Payment Method",
				},
			],
			server: {
				url: 'http://127.0.0.1:8000/getPaymentData/',
				then: data => data.map(payment => [payment.studentId, payment.Name, payment.paymentAmount, payment.paymentDate, payment.paymentReceivedByName, payment.paymentMethod])
			},
			className: {
				th: '!bg-black !text-white',
				sort: '!bg-black !text-white',
				search: '!float-right !w-[25%]',
			}
		})

		// Function to initialize the grid with dynamic columns
		async function initializeDailyTimeSlotsGrid() {
			try {
				// First fetch the data to get vehicle names
				const response = await fetch('http://127.0.0.1:8000/getSlotWiseData/');
				const data = await response.json();
				
				// Get unique vehicle names for columns
				const vehicleNames = [...new Set(data.map(vehicle => vehicle.vehicleName))];
				
				// Create the grid with dynamic columns
				const dailyTimeSlotsGrid = new gridjs.Grid({
					search: true,
					// pagination: {
					// 	limit: 5,
					// 	summary: false
					// },
					sort: true,
					fixedHeader: true,
					columns: ["Slot", ...vehicleNames],
					data: () => {
						// Transform the data to group by slot time
						const slotMap = new Map();
						
						// Process each vehicle's slots
						data.forEach(vehicle => {
							vehicle.slots.forEach(slot => {
								if (!slotMap.has(slot.slotTime)) {
									slotMap.set(slot.slotTime, {
										slotTime: slot.slotTime,
										vehicleData: {}
									});
								}
								
								// Add vehicle info to this slot
								slotMap.get(slot.slotTime).vehicleData[vehicle.vehicleName] = {
									student: slot.student,
									branch: slot.branch
								};
							});
						});
						
						// Convert to grid format
						return Array.from(slotMap.values()).map(slotData => {
							const row = [slotData.slotTime];
							
							// Add data for each vehicle column
							vehicleNames.forEach(vehicleName => {
								const vehicleInfo = slotData.vehicleData[vehicleName];
								if (vehicleInfo) {
									row.push(vehicleInfo.student || '--');
								} else {
									row.push('Slot Not Available'); // No slot for this vehicle at this time
								}
							});
							
							return row;
						});
					},
					className: {
						th: '!bg-black !text-white',
						sort: '!bg-black !text-white',
						search: '!float-right !w-[25%]',
					}
				});
				
				return dailyTimeSlotsGrid;
				
			} catch (error) {
				console.error('Error initializing grid:', error);
				
				// Fallback grid with static columns
				return new gridjs.Grid({
					search: true,
					sort: true,
					fixedHeader: true,
					columns: ["Slot", "Error loading vehicles"],
					data: [["Error", "Could not load data"]],
					className: {
						th: '!bg-black !text-white',
						sort: '!bg-black !text-white',
						search: '!float-right !w-[25%]',
					}
				});
			}
		}

		// Initialize and render the grid
		initializeDailyTimeSlotsGrid().then(grid => {
			grid.render(document.getElementById('daily-time-slots'));
		});

		// Or with async/await
		async function setupGrid() {
			const dailyTimeSlotsGrid = await initializeDailyTimeSlotsGrid();
			dailyTimeSlotsGrid.render(document.getElementById('daily-time-slots'));
		}

		const earningGrid = new gridjs.Grid({
			search: true,
			// pagination: {
			// 	limit: 5,
			// 	summary: false
			// },
			sort: true,
			fixedHeader: true,
			columns: [
				"Branch",
				"Branch Incharge",
				"Amount Received",
				"Amount Remaining",
				"Total Amount",
			],
			server: {
				url: 'http://127.0.0.1:8000/getEearningData/',
				then: data => data.map(earning => [earning.branch, earning.branchInCharge, earning.totalAmountPaid, earning.totalAmountRemaining, earning.totalEarning])
			},
			className: {
				th: '!bg-black !text-white',
				sort: '!bg-black !text-white',
				search: '!float-right !w-[25%]',
			}
		})
		
		const onLeaveGrid = new gridjs.Grid({
			search: true,
			// pagination: {
			// 	limit: 5,
			// 	summary: false
			// },
			sort: true,
			fixedHeader: true,
			columns: [
				"Name",
				"Date",
				"Slot Time",
				"status",
			],
			server: {
				url: 'http://127.0.0.1:8000/getStudentOnLeaveData/',
				then: data => data.map(onLeave => [onLeave.studentName, onLeave.date, onLeave.slotTime, onLeave.status])
			},
			className: {
				th: '!bg-black !text-white',
				sort: '!bg-black !text-white',
				search: '!float-right !w-[25%]',
			}
		})

		// appointmentBeforeLunchGrid.render(document.getElementById("appointment-table-before-lunch"))
		// appointmentAfterLunchGrid.render(document.getElementById("appointment-table-after-lunch"))
		// dailyTimeSlotsGrid.render(document.getElementById("daily-time-slots"))
		receivedPaymentGrid.render(document.getElementById("received-payment-table"))
		paymentGrid.render(document.getElementById("payment-status-table"))
		earningGrid.render(document.getElementById("earnings-table"))
		onLeaveGrid.render(document.getElementById("on-leave-table"))
	</script>
</body>

</html>